# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# TELA: NOVO ALUGUEL (com sugest√µes de endere√ßos anteriores por cliente)
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

import customtkinter as ctk
from tkinter import messagebox
from datetime import datetime

from app.database import SessionLocal
from app.models import Cliente, Cacamba, Aluguel

# ‚ûú ADICIONE ESTA LINHA:
from sqlalchemy.orm import joinedload


def construir_tela_aluguel(pai: ctk.CTkFrame) -> ctk.CTkFrame:
    frame = ctk.CTkFrame(pai, corner_radius=15)
    frame.grid_rowconfigure(tuple(range(40)), weight=0)
    frame.grid_columnconfigure(0, weight=1)

    # T√≠tulo
    ctk.CTkLabel(
        frame,
        text="üìÑ Registrar Novo Aluguel",
        font=("Segoe UI", 22, "bold")
    ).grid(row=0, column=0, pady=(20, 10))

    # ----------------- Cliente -----------------
    ctk.CTkLabel(frame, text="üë§ Cliente:", font=("Segoe UI", 14)).grid(row=1, column=0, pady=(5, 0))

    # callback quando selecionar um cliente
    def on_cliente_change(valor_escolhido: str):
        cliente_id = _option_to_id(valor_escolhido)
        carregar_sugestoes_enderecos(cliente_id)

    combo_cliente = ctk.CTkOptionMenu(frame, width=350, values=[], command=on_cliente_change)
    combo_cliente.grid(row=2, column=0, pady=5)

    # ----------------- Ca√ßamba -----------------
    ctk.CTkLabel(frame, text="üöõ Ca√ßamba dispon√≠vel:", font=("Segoe UI", 14)).grid(row=3, column=0, pady=(10, 0))
    combo_cacamba = ctk.CTkOptionMenu(frame, width=350, values=[])
    combo_cacamba.grid(row=4, column=0, pady=5)

    # ----------------- Datas -----------------
    ctk.CTkLabel(frame, text="üìÖ Data de In√≠cio (dd/mm/aaaa):", font=("Segoe UI", 14)).grid(row=5, column=0, pady=(10, 0))
    entry_inicio = ctk.CTkEntry(frame, width=350, placeholder_text="Ex: 10/07/2025")
    entry_inicio.grid(row=6, column=0, pady=5)

    ctk.CTkLabel(frame, text="üìÖ Data de Fim (dd/mm/aaaa):", font=("Segoe UI", 14)).grid(row=7, column=0, pady=(10, 0))
    entry_fim = ctk.CTkEntry(frame, width=350, placeholder_text="Ex: 15/07/2025")
    entry_fim.grid(row=8, column=0, pady=5)

    # ----------------- Endere√ßo -----------------
    ctk.CTkLabel(frame, text="üìç Endere√ßo da Obra:", font=("Segoe UI", 14)).grid(row=9, column=0, pady=(10, 0))
    entry_endereco = ctk.CTkEntry(frame, width=350, placeholder_text="Ex: Rua A, n¬∫ 123 - Bairro X")
    entry_endereco.grid(row=10, column=0, pady=5)

    # Label e OptionMenu de sugest√µes (inicialmente escondidos)
    label_sug = ctk.CTkLabel(frame, text="Endere√ßos anteriores (opcional):", font=("Segoe UI", 12))
    combo_sugestoes = ctk.CTkOptionMenu(frame, width=350, values=[])

    def on_sugestao_select(valor: str):
        # Ao escolher uma sugest√£o, preenche o entry
        if valor and not valor.startswith("‚Äî"):
            entry_endereco.delete(0, "end")
            entry_endereco.insert(0, valor)

    combo_sugestoes.configure(command=on_sugestao_select)

    def mostrar_sugestoes(enderecos: list[str]):
        """Mostra/atualiza o seletor de sugest√µes ou esconde se vazio."""
        if enderecos:
            combo_sugestoes.configure(values=enderecos)
            # placeholder visual
            try:
                combo_sugestoes.set("‚Äî selecionar endere√ßo anterior ‚Äî")
            except Exception:
                pass
            # grid apenas quando houver o que mostrar
            label_sug.grid(row=11, column=0, pady=(2, 0))
            combo_sugestoes.grid(row=12, column=0, pady=5)
        else:
            # esconder se n√£o houver sugest√µes
            try:
                label_sug.grid_remove()
                combo_sugestoes.grid_remove()
            except Exception:
                pass

    def carregar_sugestoes_enderecos(cliente_id: int | None):
        """Busca no banco os endere√ßos j√° usados por esse cliente (sem duplicar, mais recentes primeiro)."""
        if not cliente_id:
            mostrar_sugestoes([])
            return

        try:
            with SessionLocal() as db:
                registros = (
                    db.query(Aluguel.endereco_obra)
                      .filter(Aluguel.cliente_id == cliente_id)
                      .order_by(Aluguel.id.desc())
                      .all()
                )
            # flatten + √∫nicos preservando ordem
            vistos = set()
            enderecos_unicos = []
            for (end,) in registros:
                if end and end not in vistos:
                    vistos.add(end)
                    enderecos_unicos.append(end)
            # limita p/ n√£o ficar gigante
            mostrar_sugestoes(enderecos_unicos[:10])
        except Exception as e:
            messagebox.showerror("Erro", f"Falha ao carregar endere√ßos anteriores:\n{e}")
            mostrar_sugestoes([])

    # ----------------- Valor -----------------
    ctk.CTkLabel(frame, text="üí≤ Valor do aluguel (R$):", font=("Segoe UI", 14)).grid(row=13, column=0, pady=(10, 0))
    entry_valor = ctk.CTkEntry(frame, width=350, placeholder_text="Ex: 450.00")
    entry_valor.grid(row=14, column=0, pady=5)

    # ----------------- Atualizar listas (clientes/ca√ßambas) -----------------
    def _option_to_id(valor: str) -> int | None:
        if not valor or "Nenhum" in valor or "Nenhuma" in valor:
            return None
        try:
            return int(valor.split(" - ", 1)[0])
        except Exception:
            return None

    def atualizar_listas():
        with SessionLocal() as db:
            clientes = db.query(Cliente).all()
            cacambas = db.query(Cacamba).filter_by(disponivel=True).all()

        valores_clientes = [f"{c.id} - {c.nome}" for c in clientes] or ["Nenhum cliente encontrado"]
        valores_cacambas = [f"{c.id} - {c.identificacao}" for c in cacambas] or ["Nenhuma dispon√≠vel"]

        combo_cliente.configure(values=valores_clientes)
        combo_cacamba.configure(values=valores_cacambas)

        combo_cliente.set(valores_clientes[0] if valores_clientes else "")
        combo_cacamba.set(valores_cacambas[0] if valores_cacambas else "")

        # carrega sugest√µes para o cliente atualmente selecionado
        on_cliente_change(combo_cliente.get())

    atualizar_listas()

    # ----------------- Salvar -----------------
    def salvar_aluguel():
        try:
            cliente_id = _option_to_id(combo_cliente.get())
            cacamba_id = _option_to_id(combo_cacamba.get())
            if not cliente_id:
                messagebox.showwarning("Aten√ß√£o", "Selecione um cliente v√°lido.")
                return
            if not cacamba_id:
                messagebox.showwarning("Aten√ß√£o", "Selecione uma ca√ßamba dispon√≠vel.")
                return

            data_inicio = datetime.strptime(entry_inicio.get().strip(), "%d/%m/%Y")
            data_fim = datetime.strptime(entry_fim.get().strip(), "%d/%m/%Y")
            if data_fim <= data_inicio:
                messagebox.showerror("Erro", "A data de fim deve ser posterior √† data de in√≠cio.")
                return

            endereco_obra = entry_endereco.get().strip()
            if not endereco_obra:
                messagebox.showerror("Erro", "Informe o endere√ßo da obra.")
                return

            valor = float(entry_valor.get().replace(",", "."))

            with SessionLocal() as db:
                aluguel = Aluguel(
                    cliente_id=cliente_id,
                    cacamba_id=cacamba_id,
                    data_inicio=data_inicio,
                    data_fim=data_fim,
                    valor=valor,
                    endereco_obra=endereco_obra
                )
                db.add(aluguel)
                cacamba = db.get(Cacamba, cacamba_id)
                cacamba.disponivel = False
                db.commit()

            # Limpa
            combo_cacamba.set("")
            entry_inicio.delete(0, "end")
            entry_fim.delete(0, "end")
            entry_valor.delete(0, "end")
            entry_endereco.delete(0, "end")

            # Atualiza listas e sugest√µes (endere√ßo rec√©m-registrado passa a aparecer)
            atualizar_listas()
            messagebox.showinfo("Sucesso", "Aluguel registrado com sucesso!")

        except ValueError:
            messagebox.showerror("Erro", "Verifique as datas e o valor do aluguel.")
        except Exception as e:
            messagebox.showerror("Erro", f"Falha ao registrar aluguel:\n{e}")

    # Bot√µes
    ctk.CTkButton(
        frame,
        text="üíæ Salvar Aluguel",
        command=salvar_aluguel,
        fg_color="#228B22",
        hover_color="#1E6F1E",
        font=("Segoe UI", 14, "bold"),
        width=200,
        height=40
    ).grid(row=15, column=0, pady=(20, 5))

    ctk.CTkButton(
        frame,
        text="üîÑ Atualizar Ca√ßambas",
        command=atualizar_listas,
        fg_color="#1E90FF",
        hover_color="#1C86EE",
        font=("Segoe UI", 12, "bold"),
        width=200,
        height=30
    ).grid(row=16, column=0, pady=(5, 30))

    return frame



# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# TELA: REGISTRAR DEVOLU√á√ÉO
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

def construir_tela_devolucao(pai: ctk.CTkFrame) -> ctk.CTkFrame:
    frame = ctk.CTkFrame(pai, corner_radius=16)
    frame.grid_rowconfigure((0, 1, 2, 3, 4, 5, 6), weight=0)
    frame.grid_columnconfigure(0, weight=1)

    # ‚îÄ‚îÄ‚îÄ T√≠tulo ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    ctk.CTkLabel(
        frame,
        text="‚Ü©Ô∏è Devolu√ß√£o de Ca√ßambas",
        font=("Segoe UI", 26, "bold"),
        text_color="#111827"
    ).grid(row=0, column=0, pady=(30, 10), sticky="n")

    # ‚îÄ‚îÄ‚îÄ Subt√≠tulo ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    ctk.CTkLabel(
        frame,
        text="Selecione um aluguel ativo para confirmar a devolu√ß√£o:",
        font=("Segoe UI", 15),
        text_color="#374151"
    ).grid(row=1, column=0, pady=(0, 20), sticky="n")

    # ‚îÄ‚îÄ‚îÄ Combo de Alugu√©is ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    combo_var = ctk.StringVar()
    combo = ctk.CTkOptionMenu(frame, variable=combo_var, values=[], width=460)
    combo.grid(row=2, column=0, pady=(0, 10))

    # ‚îÄ‚îÄ‚îÄ Status da Opera√ß√£o ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    status_label = ctk.CTkLabel(frame, text="", font=("Segoe UI", 13))
    status_label.grid(row=3, column=0, pady=(5, 10))

    # ‚îÄ‚îÄ‚îÄ Atualizar Lista ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    def atualizar_lista_alugueis():
        with SessionLocal() as db:
            alugueis = (
                db.query(Aluguel)
                .filter_by(encerrado=False)
                .options(joinedload(Aluguel.cliente), joinedload(Aluguel.cacamba))
                .order_by(Aluguel.data_fim.asc())
                .all()
            )

        opcoes = [
            f"{a.id} - {a.cliente.nome} | {a.cacamba.identificacao} | At√©: {a.data_fim.strftime('%d/%m/%Y')}"
            for a in alugueis
        ] or ["Nenhum aluguel ativo dispon√≠vel"]

        combo.configure(values=opcoes)
        combo.set(opcoes[0])

    atualizar_lista_alugueis()

    # ‚îÄ‚îÄ‚îÄ Anima√ß√£o de status ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    def animar_status(msg, cor):
        status_label.configure(text=msg, text_color=cor)
        frame.after(3000, lambda: status_label.configure(text=""))

    # ‚îÄ‚îÄ‚îÄ Confirmar Devolu√ß√£o ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    def confirmar_devolucao():
        selecao = combo.get()
        if "Nenhum" in selecao:
            animar_status("‚ùå Nenhum aluguel selecionado", "#dc2626")
            return

        try:
            aluguel_id = int(selecao.split(" - ")[0])

            with SessionLocal() as db:
                aluguel = db.query(Aluguel).get(aluguel_id)
                aluguel.encerrado = True
                cacamba = db.query(Cacamba).get(aluguel.cacamba_id)
                cacamba.disponivel = True
                db.commit()

            animar_status("‚úÖ Devolu√ß√£o registrada com sucesso!", "#22c55e")
            atualizar_lista_alugueis()

        except Exception as e:
            messagebox.showerror("Erro", f"Ocorreu um erro: {e}")
            animar_status("‚ùå Falha ao processar devolu√ß√£o.", "#dc2626")

    # ‚îÄ‚îÄ‚îÄ Bot√£o Confirmar ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    ctk.CTkButton(
        frame,
        text="‚úÖ Confirmar Devolu√ß√£o",
        command=confirmar_devolucao,
        font=("Segoe UI", 14, "bold"),
        width=240,
        height=42,
        fg_color="#2563EB",
        hover_color="#1D4ED8",
        text_color="white",
        corner_radius=12
    ).grid(row=4, column=0, pady=(10, 5))

    # ‚îÄ‚îÄ‚îÄ Bot√£o Atualizar ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    ctk.CTkButton(
        frame,
        text="üîÑ Atualizar Lista",
        command=atualizar_lista_alugueis,
        font=("Segoe UI", 12, "bold"),
        width=200,
        height=36,
        fg_color="#9CA3AF",
        hover_color="#6B7280",
        corner_radius=10
    ).grid(row=5, column=0, pady=(0, 30))

    return frame